!function(){"use strict";const e={MODULE_NAME:"one-journal-handouts",MODULE_TITLE:"One Journal Handouts"};e.PATH=`modules/${e.MODULE_NAME}/`;const{HandlebarsApplicationMixin:t,ApplicationV2:n}=foundry.applications.api;class s extends(t(n)){static DEFAULT_OPTIONS={id:"ojh-blacklist",tag:"form",window:{get title(){return`${e.MODULE_NAME}.settings.${o.BLACKLIST}.label`},contentClasses:["standard-form"]},position:{width:400,height:"auto"},form:{handler:s.#e,closeOnSubmit:!0}};static PARTS={form:{template:`modules/${e.MODULE_NAME}/templates/blacklist-settings.hbs`,root:!0}};async _prepareContext(e){return{...await super._prepareContext(e),users:this.#t()}}#t(){const t=game.settings.get(e.MODULE_NAME,o.BLACKLIST);return game.users.map(e=>({id:e.id,name:e.name,color:e.color,blacklisted:t.includes(e.id)}))}static async#e(t,n,s){const a=Object.keys(s.object).filter(e=>s.object[e]);await game.settings.set(e.MODULE_NAME,o.BLACKLIST,a)}}const{ArrayField:a,StringField:i}=foundry.data.fields,o={GM_JOURNAL:"gm-journal",PLAYERS_JOURNAL:"players-journal",SHARING_MODE:"sharing-mode",DUPLICATED_JOURNAL:"duplicated-journal",OPEN_PAGE:"open-page",BLACKLIST:"blacklist"},r=()=>{const e={};if(game.journal){for(const[t,n]of game.journal.entries())e[t]=n.name.length>30?`${n.name.slice(0,30)}...`:n.name;return e}},l="open-page",E=async(t,n,s)=>{const a=Object.assign({},t.document.pages.find(e=>e.id===n).toObject());foundry.utils.setProperty(a,`flags.${e.MODULE_NAME}`,{pageId:n});const i=s.pages.map(e=>e.sort),o=i.length?Math.max(...i):0;a.sort=o+1e4;const[r]=await s.createEmbeddedDocuments("JournalEntryPage",[a]);return r},g=async(e,t)=>{const n=e.document.pages.find(e=>e.id===t);n&&await e.document.deleteEmbeddedDocuments("JournalEntryPage",[n.id])},c=(t,n)=>{game.socket.emit(`module.${e.MODULE_NAME}`,{event:l,journalId:t.id,pageId:n}),game.settings.get(e.MODULE_NAME,o.OPEN_PAGE)&&t.sheet.render(!0,{pageId:n,sheetMode:foundry.applications.sheets.journal.JournalEntrySheet.VIEW_MODES})};new class{constructor(){this.init()}init(){Hooks.once("init",()=>{console.log(`${e.MODULE_TITLE} | Initializing module`),game.settings.register(e.MODULE_NAME,o.BLACKLIST,{config:!1,scope:CONST.SETTING_SCOPES.WORLD,type:new a(new i,{initial:[],gmOnly:!0})}),game.settings.registerMenu(e.MODULE_NAME,o.BLACKLIST,{label:`${e.MODULE_NAME}.settings.${o.BLACKLIST}.label`,name:`${e.MODULE_NAME}.settings.${o.BLACKLIST}.name`,hint:`${e.MODULE_NAME}.settings.${o.BLACKLIST}.hint`,restricted:!0,type:s}),game.settings.register(e.MODULE_NAME,o.GM_JOURNAL,{name:`${e.MODULE_NAME}.settings.${o.GM_JOURNAL}-name`,hint:`${e.MODULE_NAME}.settings.${o.GM_JOURNAL}-hint`,scope:"world",config:!0,default:"all",type:new foundry.data.fields.StringField({blank:!1,choices:()=>foundry.utils.mergeObject({all:game.i18n.localize("all")},r())})}),game.settings.register(e.MODULE_NAME,o.PLAYERS_JOURNAL,{name:`${e.MODULE_NAME}.settings.${o.PLAYERS_JOURNAL}-name`,hint:`${e.MODULE_NAME}.settings.${o.PLAYERS_JOURNAL}-hint`,scope:"world",config:!0,default:"__!none!__",type:new foundry.data.fields.StringField({blank:!0,choices:r})}),game.settings.register(e.MODULE_NAME,o.SHARING_MODE,{name:`${e.MODULE_NAME}.settings.${o.SHARING_MODE}-name`,hint:`${e.MODULE_NAME}.settings.${o.SHARING_MODE}-hint`,scope:"world",config:!0,default:"default",type:new foundry.data.fields.StringField({blank:!1,choices:{default:game.i18n.localize("Default"),duplicate:game.i18n.localize("Duplicate"),delete:game.i18n.localize("Delete")}})}),game.settings.register(e.MODULE_NAME,o.DUPLICATED_JOURNAL,{name:`${e.MODULE_NAME}.settings.${o.DUPLICATED_JOURNAL}-name`,hint:`${e.MODULE_NAME}.settings.${o.DUPLICATED_JOURNAL}-hint`,scope:"world",config:!0,default:"__!none!__",type:new foundry.data.fields.StringField({blank:!0,choices:r})}),game.settings.register(e.MODULE_NAME,o.OPEN_PAGE,{name:`${e.MODULE_NAME}.settings.${o.OPEN_PAGE}-name`,hint:`${e.MODULE_NAME}.settings.${o.OPEN_PAGE}-hint`,scope:"world",config:!0,default:!0,type:Boolean}),game.socket.on(`module.${e.MODULE_NAME}`,({event:t,journalId:n,pageId:s})=>{if(t!==l)return;if(game.settings.get(e.MODULE_NAME,o.BLACKLIST).includes(game.users.current.id))return;const a=game.journal.get(n);a&&a.sheet.render(!0,{pageId:s,sheetMode:foundry.appv1.sheets.JournalSheet.VIEW_MODES.SINGLE})}),(()=>{const t=["getJournalSheetHeaderButtons","getHeaderControlsJournalEntrySheet"];for(const n of t)Hooks.on(n,(t,n)=>{if(!game.users.current.isGM)return;const s=game.settings.get(e.MODULE_NAME,o.GM_JOURNAL),a=game.settings.get(e.MODULE_NAME,o.PLAYERS_JOURNAL),i=game.settings.get(e.MODULE_NAME,o.SHARING_MODE),r=game.settings.get(e.MODULE_NAME,o.DUPLICATED_JOURNAL);if(s&&a&&!n.find(t=>t.class===e.MODULE_NAME)&&(t instanceof foundry.appv1.api.DocumentSheet||t instanceof foundry.applications.sheets.journal.JournalEntrySheet)){if("all"===s&&t.document.id===a)return;if("all"!==s&&t.document.id!==s)return;const o=async()=>{const n=game.journal.get(a);if(!n)return ui.notifications.error(game.i18n.localize(`${e.MODULE_NAME}.no-players-journal`));const s=t.pagesInView[0]?.dataset?.pageId;if(!s)return;const o=n.pages.find(t=>t.flags?.[e.MODULE_NAME]===s||t.flags?.[e.MODULE_NAME]?.pageId===s);if(o)c(n,o.id);else{const a=await E(t,s,n);if("duplicate"===i){const n=game.journal.get(r);if(!n)return ui.notifications.error(game.i18n.localize(`${e.MODULE_NAME}.no-duplicated-journal`));await E(t,s,n),g(t,s)}"delete"===i&&g(t,s),c(n,a.id)}ui.notifications.info(game.i18n.localize(`${e.MODULE_NAME}.successful`))};n.unshift({icon:"fas fa-square-share-nodes fa-fw",label:`${e.MODULE_NAME}.share-with-players`,class:e.MODULE_NAME,onClick:o,onclick:o})}})})()})}}}();